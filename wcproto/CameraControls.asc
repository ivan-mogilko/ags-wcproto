//-----------------------------------------------------------------------------
//
// Default camera controls module.
// Handles player input and moves/rotates camera.
//
//-----------------------------------------------------------------------------

float speed = 15.0;
float yaw, pitch, roll;

int CameraObject; // an index of space object this camera is attached to

export speed, yaw, pitch, roll;


//Joystick* joy;

/*
bool IsPOVLeftDown(this Joystick *) {
  return this.POV & 8 != 0;
}
*/

static void CameraControls::Init(int space_object) {
  mouse.SetPosition(SX, SY);
  mouse.Mode = eModePointer;
  //if (JoystickCount() > 0) joy = Joystick.Open(0);
  CameraObject = space_object;
  
  // sync camera pos with the object
  cam_pos.x = SO_point[CameraObject].x;
  cam_pos.y = SO_point[CameraObject].y;
  cam_pos.z = SO_point[CameraObject].z;
  Camera3D.UpdateTransforms();
}

static void CameraControls::HandleInput() {
  if (CameraObject < 0)
    return;
  
  yaw = IntToFloat(mouse.x - SX) / IntToFloat(SX * 4);
  pitch = IntToFloat(mouse.y - SY) / IntToFloat(SY * 4);
   
  float rollTarget = 0.2 * IntToFloat(IsKeyPressed(eKeyD) - IsKeyPressed(eKeyA));
  roll += (rollTarget - roll) * 0.07;
  
  float speedTarget;
  speed += 10.0 * IntToFloat(IsKeyPressed(eKeyW) - IsKeyPressed(eKeyS));
  if (speed < 0.0) speed = 0.0;
  if (speed > 500.0) speed = 500.0;
  
  /*
  if (joy != null) {
    yaw = IntToFloat(joy.x) / IntToFloat(JOY_RANGE * 5);
    pitch = IntToFloat(-joy.y) / IntToFloat(JOY_RANGE * 5);
  
    float lim = 0.06;
    if (abs(yaw) < lim) yaw = 0.0; else yaw -= sgn(yaw) * lim;
    if (abs(pitch) < lim) pitch = 0.0; else pitch -= sgn(pitch) * lim;
    
    roll = IntToFloat(joy.GetAxis(4)) / IntToFloat(JOY_RANGE * 4);
    if (abs(roll) < lim) roll = 0.0;
    
    speedTarget = IntToFloat(joy.GetAxis(2) > 10) * 500.0;
    speed += 10.0 * sgn(speedTarget - speed);
    
    lblDebug.Text = String.Format("%d", joy.IsPOVLeftDown());
  }
  */
  
  // Instant velocity shift
  SO_vel[CameraObject].SetXYZ(SO_dir[CameraObject].x, SO_dir[CameraObject].y, SO_dir[CameraObject].z);
  SO_vel[CameraObject].Scale(speed);
  // TODO: move this to Ship Controls module
  // TODO: support proper thrust mechanics with inertia (an option)
}

static void CameraControls::Update() {
  if (CameraObject < 0)
    return;

  Camera3D.UpdateRotations(speed, yaw, pitch, roll);
  
  // copy dir vector to space object
  // TODO: do other way around later
  SO_dir[CameraObject].SetXYZ(cam_dir.x, cam_dir.y, cam_dir.z);
  
  // sync camera pos with the object
  cam_pos.x = SO_point[CameraObject].x;
  cam_pos.y = SO_point[CameraObject].y;
  cam_pos.z = SO_point[CameraObject].z;
  Camera3D.UpdateTransforms();
}
